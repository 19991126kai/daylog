<%# æˆ»ã‚‹ãƒœã‚¿ãƒ³ %>
<%= link_to categories_path,
  class: "inline-flex items-center justify-center w-10 h-10 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-gray-400 transition",
  aria: { label: "æˆ»ã‚‹" } do %>
  <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
    <path d="M7.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4A1 1 0 018.707 6.293L6.414 8.586H17a1 1 0 110 2H6.414l2.293 2.293a1 1 0 010 1.414z"/>
  </svg>
<% end %>

<section class="max-w-3xl mx-auto px-4">
  <h2 id="category-name" class="text-2xl font-bold text-blue-900 my-6 border-b border-blue-900 pb-2"><%= @category.name %></h2>
  <p class="text-center text-gray-600 mb-6">ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒ»ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ä½¿ã£ã¦é›†ä¸­ã—ã‚ˆã†â˜•<br>é–‹å§‹ãƒœã‚¿ãƒ³ã§ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ</p>
  <%= form_with model: @log, url: logs_path, method: :post, local: true, class: "w-full max-w-md mb-8 mx-auto", id: "timer-form" do |f| %>
    <div class="mb-6">
      <%= hidden_field_tag "log[category_id]", @category.id %>
      <%= hidden_field_tag "log[start_time]", "", id: "log-start-time" %>
      <%= hidden_field_tag "log[end_time]", "", id: "log-end-time" %>
      <%= hidden_field_tag "log[duration]", "", id: "log-duration" %>
    </div>
  <% end %>
  <div class="flex w-1/2 mx-auto mb-6 border-b border-gray-200 select-none">
    <div id="work-tab" class="active w-1/2 text-center py-2 font-semibold text-blue-900 border-b-2 border-blue-900 cursor-pointer">
      å­¦ç¿’
    </div>
    <div id="break-tab" class="w-1/2 text-center py-2 font-semibold text-gray-500 hover:text-blue-800 cursor-pointer">
      ä¼‘æ†©
    </div>
  </div>
  <div id="timer" class="flex flex-col items-center gap-8">
    <%# ã‚¿ã‚¤ãƒãƒ¼ç§’æ•°è¡¨ç¤º %>
    <div class="font-bold tabular-nums tracking-wider text-8xl my-5">
      <span id="timer-display">25:00</span>
    </div>
    <%# ã‚¿ã‚¤ãƒãƒ¼æ“ä½œãƒœã‚¿ãƒ³ %>
    <div class="flex items-center gap-4">
      <button id="btn-start"
              class="bg-blue-900 text-white font-semibold py-3 px-8 rounded hover:bg-blue-800 hover:cursor-pointer transition">
        é–‹å§‹
      </button>
      <button id="btn-pause"
              class="hidden bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded hover:bg-gray-300 hover:cursor-pointer transition">
        ä¸€æ™‚åœæ­¢
      </button>
      <button id="btn-finish"
              class="hidden bg-emerald-600 text-white font-semibold py-3 px-8 rounded hover:bg-emerald-700 hover:cursor-pointer transition">
        çµ‚äº†
      </button>
    </div>
  </div>
</section>

<%# å­¦ç¿’æ™‚é–“ã‚µãƒãƒª %>
<section class="max-w-3xl mx-auto px-4 my-10">
  <div class="text-center mb-4 text-gray-700 outlint-gray-300 p-4 rounded bg-white border border-gray-200">
    <p class="text-gray-600 mb-6">ä»Šæ—¥ã®é ‘å¼µã‚Šã‚’ã‚·ã‚§ã‚¢ã—ã‚ˆã†ğŸ“£</p>
    <div class="mb-4">
      æœ¬æ—¥ã®å­¦ç¿’æ™‚é–“: 
        <span id="daily-hour" class="font-bold text-blue-900"><%= @today_total_duration / 60 %></span>æ™‚é–“
        <span id="daily-min" class="font-bold text-blue-900"><%= @today_total_duration % 60 %></span>åˆ†
      <br>
      ã“ã‚Œã¾ã§ã®ç´¯è¨ˆ: 
        <span id="cumulative-hour" class="font-bold text-blue-900"><%= @total_duration / 60 %></span>æ™‚é–“
        <span id="cumulative-min" class="font-bold text-blue-900"><%= @total_duration % 60 %></span>åˆ†
    </div>
    <button id="btn-open-x" class="mb-4 bg-black text-white font-semibold py-2 px-4 rounded hover:bg-blue-800 hover:cursor-pointer transition">
      <i class="devicon-twitter-original mr-2"></i>ã‚·ã‚§ã‚¢ã™ã‚‹
    </button>
  </div>
</section>

<%# ãƒ­ã‚°ä¸€è¦§ %>
<section class="max-w-3xl mx-auto px-4 my-10">
  <h2 class="text-2xl font-bold text-blue-900 my-6 border-b border-blue-900 pb-2">å­¦ç¿’è¨˜éŒ²</h2>
  <button>
    <%= link_to "æ‰‹å‹•ã§è¿½åŠ ã™ã‚‹", new_log_path(category_id: @category.id),
      class: "inline-block mb-4 bg-blue-900 text-white font-semibold py-2 px-4 rounded hover:bg-blue-800 hover:cursor-pointer transition" %>
  </button>
  <% if @logs.present? %>
    <ul class="divide-y divide-gray-200 rounded-xl border border-gray-200 bg-white">
      <% @logs.each do |log| %>
        <%= render "logs/log", log: log %>
      <% end %>
    </ul>
  <% else %>
    <div class="rounded-xl border border-dashed p-8 text-center text-gray-600 bg-white">
      <p>ã“ã®ã‚«ãƒ†ã‚´ãƒªã®å­¦ç¿’è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã‚¿ã‚¤ãƒãƒ¼ã§ã€Œé–‹å§‹ã€ã—ã¦è¨˜éŒ²ã—ã¾ã—ã‚‡ã†ã€‚</p>
    </div>
  <% end %>
</section>

<script>
  // Workerå®šç¾©
  const workerSrc = `
    let leftSec;
    let paused;
    let timerId;

    const postTick = () => {
      self.postMessage({ type: 'tick', leftSec });
    };

    const clearTimer = () => {
      if (timerId !== null) {
        clearInterval(timerId);
        timerId = null;
      }
    };

    // Main â†’ Workerã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    self.addEventListener('message', (e) => {
      const msg = e.data || {};
      switch (msg.type) {
        case 'start': {
          clearTimer();
          leftSec = (msg.leftSec);
          paused = false;
          postTick();

          timerId = setInterval(() => {
            // ä¸€æ™‚åœæ­¢ä¸­ã¯ã‚¹ã‚­ãƒƒãƒ—
            if (paused) return;
            if (leftSec > 0) {
              leftSec -= 1;
              postTick();
              if (leftSec === 0) {
                clearTimer();
                self.postMessage({ type: 'done' });
              }
            }
          }, 1000);
          break;
        }

        case 'pause': {
          paused = true;
          break;
        }

        case 'resume': {
          paused = false;
          break;
        }

        case 'stop': {
          clearTimer();
          self.postMessage({ type: 'stopped' });
          break;
        }
      }
    });
  `;

  // Workerç”Ÿæˆ
  const blob = new Blob([workerSrc], { type: "application/javascript" });
  const workerURL = URL.createObjectURL(blob);
  const worker = new Worker(workerURL);

  document.addEventListener("turbo:load", () => {
    const workTab = document.getElementById("work-tab");
    const breakTab = document.getElementById("break-tab");
    const timerDisplay = document.getElementById("timer-display");
    const startBtn = document.getElementById("btn-start");
    const pauseBtn = document.getElementById("btn-pause");
    const finishBtn = document.getElementById("btn-finish");
    const form = document.getElementById("timer-form");
    const startField = document.getElementById("log-start-time");
    const endField = document.getElementById("log-end-time");
    const durationField = document.getElementById("log-duration");

    const activeClassArr   = ["active", "text-blue-900", "border-b-2", "border-blue-900"];
    const inactiveClassArr = ["text-gray-500", "hover:text-blue-800"];

    // ãƒ¢ãƒ¼ãƒ‰å®šç¾©
    const Mode = { WORK: "work", BREAK: "break" };
    const DURATION_BY_MODE = { [Mode.WORK]: 25 * 60, [Mode.BREAK]: 5 * 60 };  // LSB: 1ç§’

    let intervalId = null;
    let leftSec; // LSB: 1sec
    let isPaused = false;
    let startedLeftSec;
    let startedAt;

    // Worker â†’ Mainã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    worker.onmessage = (e) => {
      const msg = e.data;

      switch (msg.type) {
        case 'tick': {
          leftSec = msg.leftSec;
          updateTimerDisplay();
          break;
        };

        case "done": {
          intervalId = null;
          alert("çµ‚äº†ï¼");
          submitLog(Date.now());
          isPaused = false;
          leftSec = DURATION_BY_MODE[currentMode()];
          showIdleUI();
          startedLeftSec = null;
          startedAt = null;
          updateTimerDisplay();
          break;
        };

        case "stopped": {
          intervalId = null;
          submitLog(Date.now());
          isPaused = false;
          leftSec = DURATION_BY_MODE[currentMode()];
          showIdleUI();
          startedLeftSec = null;
          startedAt = null;
          updateTimerDisplay();
          break;
        }
      }
    };

    worker.addEventListener("error", (err) => {
      console.error(err);
    });

    // ã‚¿ã‚¤ãƒãƒ¼ãƒšãƒ¼ã‚¸ä»¥å¤–ã§ã¯ä½•ã‚‚ã—ãªã„
    if (!workTab) {
      return;
    };

    // ã‚¿ã‚¤ãƒãƒ¼å‹•ä½œä¸­ã‹ãƒã‚§ãƒƒã‚¯é–¢æ•°
    const isRunning = () => {
      return intervalId !== null;
    };

    // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰å–å¾—
    const currentMode = () => {
      return workTab.classList.contains("active") ? Mode.WORK : Mode.BREAK;
    };

    // å­¦ç¿’ï¼ä¼‘æ†©ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
    const setActiveTab = (activeEl, inactiveEl) => {
      activeEl.classList.remove(...inactiveClassArr);
      activeEl.classList.add(...activeClassArr);

      inactiveEl.classList.remove(...activeClassArr);
      inactiveEl.classList.add(...inactiveClassArr);
    };

    // 1æ¡ç›®ã‚’0åŸ‹ã‚ã™ã‚‹é–¢æ•°
    const zeroPadding = (n) => {
      return String(n).padStart(2, "0")
    };

    // MM:SS ã®å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
    const formatMMSS = (sec) => {
      return `${zeroPadding(Math.floor(sec / 60))}:${zeroPadding(sec % 60)}`
    };

    // Railsç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ YYYY-MM-DD HH:MM:SS
    const toRailsTS = (ms) => {
      const d = new Date(ms);
      const Y = d.getFullYear(), M = zeroPadding(d.getMonth()+1), D = zeroPadding(d.getDate());
      const h = zeroPadding(d.getHours()), m = zeroPadding(d.getMinutes()), s = zeroPadding(d.getSeconds());
      return `${Y}-${M}-${D} ${h}:${m}:${s}`;
    };

    // ãƒ­ã‚°é€ä¿¡å‡¦ç†
    const submitLog = (endedAt) => {
      // ä¼‘æ†©æ™‚é–“ã¯ä¿å­˜ã—ãªã„
      if (currentMode() !== Mode.WORK) {
        return;
      };

      const duration = Math.floor((startedLeftSec - leftSec) / 60);
      // 1åˆ†æœªæº€ãªã‚‰ä¿å­˜ã—ãªã„
      if (duration === 0) {
        return;
      }

      startField.value  = toRailsTS(startedAt);
      endField.value = toRailsTS(endedAt);
      durationField.value = duration;
      form.submit();
    };

    // ã‚¿ã‚¤ãƒãƒ¼ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–ã®æ®‹ã‚Šç§’æ•°æ›´æ–°
    const updateTimerDisplay = () => {
      timerDisplay.textContent = formatMMSS(leftSec);
      document.title = `${formatMMSS(leftSec)}`;
    };

    // ã‚¿ãƒ–ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹å…±é€šé–¢æ•°
    const activateMode = (newMode) => {
      // ã‚¿ã‚¤ãƒãƒ¼å‹•ä½œä¸­ã¯ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆä¸å¯
      if (isRunning()) {
        return;
      }
      const isWork = (newMode === Mode.WORK);
      leftSec = DURATION_BY_MODE[newMode];
      setActiveTab((isWork ? workTab : breakTab), (isWork ? breakTab : workTab)); // ä¸‰é …æ¼”ç®—å­ã§å¼•æ•°ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã‚‹
      updateTimerDisplay();
    };

    // å­¦ç¿’ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯
    workTab.addEventListener("click", () => {
      if (!workTab.classList.contains("active")) {
        activateMode(Mode.WORK);
      };
    });

    // ä¼‘æ†©ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯
    breakTab.addEventListener("click", () => {
      if (!breakTab.classList.contains("active")) {
        activateMode(Mode.BREAK);
      }
    });

    // UIåˆ‡æ›¿ï¼ˆåˆæœŸçŠ¶æ…‹â†’ã‚¿ã‚¤ãƒãƒ¼ä½œå‹•ï¼‰
    const showRunningUI = () => {
      startBtn.classList.add("hidden");
      pauseBtn.classList.remove("hidden");
      finishBtn.classList.remove("hidden");
    };

    // UIåˆ‡ã‚Šæ›¿ãˆï¼ˆã‚¿ã‚¤ãƒãƒ¼ä½œå‹•çŠ¶æ…‹â†’åˆæœŸçŠ¶æ…‹ï¼‰
    const showIdleUI = () => {
      startBtn.classList.remove("hidden");
      pauseBtn.classList.add("hidden");
      finishBtn.classList.add("hidden");
      pauseBtn.innerText = "ä¸€æ™‚åœæ­¢";
      timerDisplay.classList.remove("text-gray-600");
    };

    // é–‹å§‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    startBtn.addEventListener("click", () => {
      if (isRunning()) return; // äºŒé‡èµ·å‹•ã‚¬ãƒ¼ãƒ‰

      startedLeftSec = leftSec;
      startedAt = Date.now();

      worker.postMessage({ type: "start", leftSec: leftSec });

      // å¾“æ¥ã‚³ãƒ¼ãƒ‰äº’æ›ï¼šå‹•ä½œä¸­åˆ¤å®šç”¨ã«ãƒ€ãƒŸãƒ¼å€¤ã‚’ã‚»ãƒƒãƒˆ
      intervalId = 1;

      showRunningUI();
      updateTimerDisplay();
    });

    // ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    pauseBtn.addEventListener("click", () => {
      if (!isRunning()) return; // é–‹å§‹å‰ã¯ç„¡è¦–

      isPaused = !isPaused;
      pauseBtn.innerText = isPaused ? "å†é–‹" : "ä¸€æ™‚åœæ­¢";
      timerDisplay.classList.toggle("text-gray-600", isPaused);
      worker.postMessage({ type: isPaused ? "pause" : "resume" });
    });

    // çµ‚äº†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    finishBtn.addEventListener("click", () => {
      if (!isRunning()) return; // é–‹å§‹å‰ã¯ç„¡è¦–

      worker.postMessage({ type: "stop" });
    });

    // åˆæœŸè¡¨ç¤º
    activateMode(Mode.WORK);

    document.addEventListener("turbo:before-visit", (e) => {
      if (isRunning()) {
        e.preventDefault();
        alert("ã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ä½œä¸­ã¯ãƒšãƒ¼ã‚¸ã‚’ç§»å‹•ã§ãã¾ã›ã‚“ã€‚");
      }
    });
  });

  (function () {
    const CSRF = "<%= form_authenticity_token %>";

    function ensureMenu() {
      let m = document.getElementById("floating-kebab-menu");
      if (!m) {
        m = document.createElement("div");
        m.id = "floating-kebab-menu";
        m.className = "hidden border border-gray-200 bg-white rounded-lg shadow w-40 p-1";
        m.style.position = "fixed"; // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å½±éŸ¿ã—ãªã„
        document.body.appendChild(m);
      }
      return m;
    }

    function buildMenuHTML(editUrl, deleteUrl, name) {
      return `
        <a href="${editUrl}" class="block px-3 py-2 text-sm hover:bg-gray-50" role="menuitem">ç·¨é›†</a>
        <form method="post" action="${deleteUrl}" class="block" role="menuitem"
              onsubmit="return confirm('${name} ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')">
          <input type="hidden" name="authenticity_token" value="${CSRF}">
          <input type="hidden" name="_method" value="delete">
          <button type="submit" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">å‰Šé™¤</button>
        </form>
      `;
    }

    let openBtn = null;

    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-kebab-button]");
      const menu = ensureMenu();

      // å¤–å´ã‚¯ãƒªãƒƒã‚¯ â†’ é–‰ã˜ã‚‹
      if (!btn) {
        if (!menu.classList.contains("hidden")) menu.classList.add("hidden");
        openBtn = null;
        return;
      }

      // åŒã˜ãƒœã‚¿ãƒ³ â†’ ãƒˆã‚°ãƒ«é–‰ã˜
      if (openBtn === btn && !menu.classList.contains("hidden")) {
        menu.classList.add("hidden"); openBtn = null; return;
      }

      // å†…å®¹å·®ã—æ›¿ãˆ
      menu.innerHTML = buildMenuHTML(
        btn.getAttribute("data-edit-url"),
        btn.getAttribute("data-delete-url"),
        btn.getAttribute("data-name") || "ã“ã®ãƒ­ã‚°"
      );

      // ä½ç½®ï¼šãƒœã‚¿ãƒ³ç›´ä¸‹ãƒ»å³å¯„ã›ï¼ˆç”»é¢å¤–ã¯è£œæ­£ï¼‰
      const r = btn.getBoundingClientRect();
      const top = r.bottom + 6;
      menu.style.top = top + "px";
      menu.classList.remove("hidden");
      const mw = menu.offsetWidth || 160;
      const left = Math.min(Math.max(8, r.right - mw), window.innerWidth - mw - 8);
      menu.style.left = left + "px";

      openBtn = btn;
    });

    ["keydown", "scroll", "resize"].forEach((ev) => {
      window.addEventListener(ev, (e) => {
        if (ev === "keydown" && e.key !== "Escape") return;
        const m = document.getElementById("floating-kebab-menu");
        if (m) m.classList.add("hidden");
        openBtn = null;
      }, { passive: true });
    });
  })();

  const catName = document.getElementById("share-category");
  const btnOpenX = document.getElementById("btn-open-x");

  const today = () => {
    const date = new Date();
    // const year = date.getFullYear();
    const month = String(date.getMonth() + 1);
    const day = String(date.getDate());
    const days = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"]; // æ›œæ—¥é…åˆ—
    const weekday = days[date.getDay()];
    return `${month}/${day}(${weekday})`;
  };

  // ãƒã‚¹ãƒˆã™ã‚‹æ–‡ç« ä½œæˆ
  const buildPostText = () => {
    const dateText = today();
    const catNameText = document.getElementById("category-name").textContent;
    const dailyText = document.getElementById("daily-hour").textContent + "æ™‚é–“" + 
                      document.getElementById("daily-min").textContent + "åˆ†";
    const cumText   = document.getElementById("cumulative-hour").textContent + "æ™‚é–“" + 
                      document.getElementById("cumulative-min").textContent + "åˆ†";

    return `ã€${dateText} å­¦ç¿’è¨˜éŒ²ã€‘\nâœ…å†…å®¹ï¼š${catNameText}\n\nğŸ’¡å­¦ã‚“ã ã“ã¨\nãƒ»\nãƒ»\nãƒ»\n\nâ°å­¦ç¿’æ™‚é–“\n${dailyText} (ç´¯è¨ˆ:${cumText})\n#Daylog`;
  };

  // XæŠ•ç¨¿ç”»é¢è¡¨ç¤º
  const openXIntent = () => {
    const text = buildPostText();
    const intent = `https://x.com/intent/Post?text=${encodeURIComponent(text)}`;
    window.open(intent, "_blank", "noopener,noreferrer,width=600,height=600");

  };

  // Xãƒã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  btnOpenX.addEventListener("click", (e) => {
    e.preventDefault();
    openXIntent();
  });
</script>
