<div class="max-w-3xl mx-auto px-4">
  <h2 class="text-2xl font-bold text-blue-900 my-6 border-b pb-2">è¨˜éŒ²ã™ã‚‹</h2>
  <p class="text-xl font-bold my-10">ãŠã‹ãˆã‚Šãªã•ã„ğŸ™Œ<br>ä»Šæ—¥ã¯ä½•ã‚’å­¦ç¿’ã—ã¾ã™ã‹ï¼Ÿ</p>

  <% if @categories.any? %>
    <ul class="space-y-4">
      <% @categories.each do |c| %>
        <li class="rounded-xl bg-white hover:bg-gray-200 hover:cursor-pointer transition">
          <div class="flex items-center justify-between">
            <!-- ã‚«ãƒ†ã‚´ãƒªåãƒœã‚¿ãƒ³ -->
            <%= form_with url: timer_path, method: :get, local: true, class: "flex-1" do %>
              <%= hidden_field_tag :category_id, c.id %>
              <button type="submit"
                      class="py-5 px-5 w-full text-left font-medium hover:cursor-pointer">
                <%= c.name %>
              </button>
            <% end %>

            <!-- ä¸‰ç‚¹ãƒªãƒ¼ãƒ€ï¼ˆç·¨é›†/å‰Šé™¤ï¼‰ -->
            <button type="button"
                    class="p-2 mr-5 rounded hover:bg-gray-100"
                    title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼"
                    aria-haspopup="menu"
                    data-kebab-button
                    data-edit-url="<%= edit_category_path(c) %>"
                    data-delete-url="<%= (c.respond_to?(:is_default) && c.is_default?) ? '' : category_path(c) %>"
                    data-name="<%= c.name %>">
              <!-- æ¨ªå‘ã 3ç‚¹ -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                   fill="currentColor" class="w-5 h-5">
                <path d="M6.25 10a1.25 1.25 0 11-2.5 0 1.25 1.25 0 012.5 0zM11.25 10a1.25 1.25 0 11-2.5 0 1.25 1.25 0 012.5 0zM16.25 10a1.25 1.25 0 11-2.5 0 1.25 1.25 0 012.5 0z"/>
              </svg>
            </button>
          </div>
        </li>
      <% end %>
    </ul>
  <% else %>
    <div class="rounded-xl border border-dashed p-10 text-center text-gray-600 bg-white">
      <p class="mb-3">ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“</p>
      <p class="text-sm">ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¦å­¦ç¿’ã®è¨˜éŒ²ã‚’ã¯ã˜ã‚ã¾ã—ã‚‡ã†</p>
    </div>
  <% end %>

  <!-- ã€Œæœªåˆ†é¡ã§è¨˜éŒ²ã™ã‚‹ã€ãƒœã‚¿ãƒ³ -->
  <div class="flex justify-center mt-6">
    <%= link_to "æœªåˆ†é¡ã§è¨˜éŒ²ã™ã‚‹", timer_path, class: "text-sm underline text-gray-700" %>
  </div>

  <!-- ã€Œã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã™ã‚‹ã€ãƒœã‚¿ãƒ³ -->
  <div class="flex justify-center mt-8">
    <%= link_to "ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã™ã‚‹", new_category_path,
          class: "rounded-xl border border-gray-400  px-6 py-3 text-base hover:bg-gray-200 transition" %>
  </div>
</div>

<script>
(function () {
  const CSRF = "<%= form_authenticity_token %>";

  function ensureMenu() {
    let m = document.getElementById("floating-kebab-menu");
    if (!m) {
      m = document.createElement("div");
      m.id = "floating-kebab-menu";
      m.className = "hidden border border-gray-200 bg-white rounded-lg shadow w-40 p-1";
      m.style.position = "fixed"; // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å½±éŸ¿ã—ãªã„
      document.body.appendChild(m);
    }
    return m;
  }

  function buildMenuHTML(editUrl, deleteUrl, name) {
    const edit = `<a href="${editUrl}" class="block px-3 py-2 text-sm hover:bg-gray-50" role="menuitem">ç·¨é›†</a>`;
    const del = deleteUrl
      ? `<form method="post" action="${deleteUrl}" class="block" role="menuitem"
               onsubmit="return confirm('${name} ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')">
           <input type="hidden" name="authenticity_token" value="${CSRF}">
           <input type="hidden" name="_method" value="delete">
           <button type="submit" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">å‰Šé™¤</button>
         </form>`
      : `<span class="block px-3 py-2 text-sm text-gray-400 select-none" role="menuitem">å‰Šé™¤</span>`;
    return edit + del;
  }

  let openBtn = null;

  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-kebab-button]");
    const menu = ensureMenu();

    // å¤–å´ã‚¯ãƒªãƒƒã‚¯ â†’ é–‰ã˜ã‚‹
    if (!btn) {
      if (!menu.classList.contains("hidden")) menu.classList.add("hidden");
      openBtn = null;
      return;
    }

    // å†…å®¹å·®ã—æ›¿ãˆ
    menu.innerHTML = buildMenuHTML(
      btn.getAttribute("data-edit-url"),
      btn.getAttribute("data-delete-url"),
      btn.getAttribute("data-name") || ""
    );

    // ä½ç½®ï¼šãƒœã‚¿ãƒ³ç›´ä¸‹ãƒ»å³å¯„ã› ç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†è£œæ­£
    const r = btn.getBoundingClientRect();
    const top = r.bottom + 6;
    menu.style.top = top + "px";
    menu.classList.remove("hidden");
    const mw = menu.offsetWidth || 160;
    const left = Math.min(Math.max(8, r.right - mw), window.innerWidth - mw - 8);
    menu.style.left = left + "px";

    openBtn = btn;
  });

})();
</script>
