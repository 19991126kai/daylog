<section class="py-12 px-4 max-w-3xl mx-auto">
  <div class="max-w-5xl mx-auto bg-white p-8 rounded shadow-md">
    <h2 class="text-3xl font-bold text-blue-900 mb-8 border-b pb-2">ã‚·ã‚§ã‚¢</h2>

    <%= form_with url: share_path, method: :get, local: true, id: "x-share-form", class: "w-full max-w-md mb-8 mx-auto" do %>
      <div class="mb-6">
        <label for="share-date" class="block text-gray-700 text-sm font-semibold mb-2">æ—¥ä»˜</label>
        <input type="date"
               id="share-date"
               name="date"
               value="<%= @date.strftime('%Y-%m-%d') %>"
               class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <div class="mb-6">
        <label for="share-category" class="block text-gray-700 text-sm font-semibold mb-2">ã‚«ãƒ†ã‚´ãƒª</label>
        <%= select_tag :category_id,
              options_from_collection_for_select(@categories, :id, :name, @category_id),
              id: "share-category",
              class: "w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>
    <% end %>

    <div class="text-gray-500 text-sm mb-1 text-center">å­¦ç¿’æ™‚é–“ï¼š</div>
    <div class="text-3xl font-bold text-gray-900 text-center">
      <span id="daily-min"
            data-minutes="<%= @daily_minutes %>"><%= minutes_to_hm(@daily_minutes) %></span>
    </div>

    <div class="text-gray-500 text-sm mb-1 text-center">ç´¯è¨ˆï¼š</div>
    <div class="text-3xl font-bold text-gray-900 text-center">
      <span id="cumulative-min"
            data-minutes="<%= @cumulative_minutes %>"><%= minutes_to_hm(@cumulative_minutes) %></span>
    </div>

    <div id="btn-open-x" class="mt-8 text-center">
      <button class="bg-gray-900 font-bold text-white py-2 px-8 rounded hover:bg-gray-800 hover:cursor-pointer transition inline-flex items-center gap-2">
        <span class="material-symbols-outlined text-sm">ios_share</span>
        <p>X ã«ãƒã‚¹ãƒˆã™ã‚‹</p>
      </button>
    </div>
  </div>
</section>
<script>
document.addEventListener("turbo:load", () => {
  const form = document.getElementById("x-share-form");
  const dateInput = document.getElementById("share-date");
  const catSelect = document.getElementById("share-category");
  const btnOpenX = document.getElementById("btn-open-x");

  // ãƒ•ã‚©ãƒ¼ãƒ ã®å€¤ãŒå¤‰åŒ–ã—ãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã—ã¦å†æç”»ã™ã‚‹
  const onChange = () => form.submit();
  dateInput.addEventListener("change", onChange);
  catSelect.addEventListener("change", onChange);

  const toHM = (minutes, padMinutes = true) => {
    const m = Math.max(0, parseInt(minutes, 10) || 0);
    const h = Math.floor(m / 60);
    const r = m % 60;
    const mm = padMinutes ? String(r).padStart(2, "0") : r;
    if (h && r) return `${h}æ™‚é–“${mm}åˆ†`;
    if (h)      return `${h}æ™‚é–“`;
    return `${r}åˆ†`;
  };

  // ãƒã‚¹ãƒˆã™ã‚‹æ–‡ç« ä½œæˆ
  const buildPostText = () => {
    const date = document.getElementById("share-date").value;
    const catSelect = document.getElementById("share-category");
    const selected  = catSelect.options[catSelect.selectedIndex];
    const catName   = (catSelect.value && selected) ? selected.text : "æœªåˆ†é¡";

    // ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ•´å½¢æ¸ˆã¿ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾ä½¿ã†
    const dailyText = document.getElementById("daily-min").textContent;
    const cumText   = document.getElementById("cumulative-min").textContent;

    return `ã€${date} å­¦ç¿’è¨˜éŒ²ã€‘\nâœ…å†…å®¹\n${catName}\n\nğŸ’¡å­¦ã‚“ã ã“ã¨\n\nâ°å­¦ç¿’æ™‚é–“\n${dailyText} (ç´¯è¨ˆ:${cumText})\n`;
  };

  // XæŠ•ç¨¿ç”»é¢è¡¨ç¤º
  const shareUrl = "<%= root_url %>";
  const openXIntent = () => {
    const text = buildPostText();
    const intent = `https://x.com/intent/Post?text=${encodeURIComponent(text)}&hashtags=Daylog`;
    window.open(intent, "_blank", "noopener,noreferrer,width=600,height=600");
  };

  // Xãƒã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  btnOpenX.addEventListener("click", (e) => {
    e.preventDefault();
    openXIntent();
  });
});
</script>


