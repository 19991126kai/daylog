<section class="py-12 px-4 max-w-3xl mx-auto">
  <div class="max-w-5xl mx-auto bg-white p-8 rounded shadow-md">
    <h2 class="text-3xl font-bold text-blue-900 mb-8 border-b pb-2">シェア</h2>

    <%= form_with url: share_path, method: :get, local: true, id: "x-share-form", class: "w-full max-w-md mb-8 mx-auto" do %>
      <div class="mb-6">
        <label for="share-date" class="block text-gray-700 text-sm font-semibold mb-2">日付</label>
        <input type="date"
               id="share-date"
               name="date"
               value="<%= @date.strftime('%Y-%m-%d') %>"
               class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <div class="mb-6">
        <label for="share-category" class="block text-gray-700 text-sm font-semibold mb-2">カテゴリ</label>
        <%= select_tag :category_id,
              options_from_collection_for_select(@categories, :id, :name, @category_id),
      include_blank: "未分類",
              include_blank: "未分類",
              id: "share-category",
              class: "w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>
    <% end %>

    <div class="text-gray-500 text-sm mb-1 text-center">学習時間：</div>
    <div class="text-3xl font-bold text-gray-900 text-center"><span id="daily-min"><%= @daily_minutes %></span> 分</div>
    <div class="text-gray-500 text-sm mb-1 text-center">累計：</div>
    <div class="text-3xl font-bold text-gray-900 text-center"><span id="cumulative-min"><%= @cumulative_minutes %></span> 分</div>

    <div id="btn-open-x" class="mt-8 text-center">
      <button class="bg-gray-900 font-bold text-white py-2 px-8 rounded hover:bg-gray-800 hover:cursor-pointer transition inline-flex items-center gap-2">
        <span class="material-symbols-outlined text-sm">ios_share</span>
        <p>X にポストする</p>
      </button>
    </div>
  </div>
</section>
<script>
document.addEventListener("turbo:load", () => {
  const form = document.getElementById("x-share-form");
  const dateInput = document.getElementById("share-date");
  const catSelect = document.getElementById("share-category");
  const btnOpenX = document.getElementById("btn-open-x");

  // フォームの値が変化したらフォーム送信して再描画する
  const onChange = () => form.submit();
  dateInput.addEventListener("change", onChange);
  catSelect.addEventListener("change", onChange);

  // ポストする文章作成
  const buildPostText = () => {
    const date = dateInput.value;
    const selected = catSelect.options[catSelect.selectedIndex];
    const catName = (catSelect.value && selected) ? selected.text : "未分類";

    const daily = document.getElementById("daily-min").textContent;
    const cum   = document.getElementById("cumulative-min").textContent;

    return `学習記録 ${date}\n${catName}：当日 ${daily} 分（累計 ${cum} 分）\n#Daylog #学習記録`;
  };

  // X投稿画面表示
  const shareUrl = "<%= root_url %>";
  const openXIntent = () => {
    const text = buildPostText();
    const intent = `https://x.com/intent/Post?text=${encodeURIComponent(text)}&url=${encodeURIComponent(shareUrl)}`;
    window.open(intent, "_blank", "noopener,noreferrer,width=600,height=600");
  };

  // Xポストボタンクリック
  btnOpenX.addEventListener("click", (e) => {
    e.preventDefault();
    openXIntent();
  });
});
</script>


